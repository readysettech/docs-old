# Caching Query Result Sets with ReadySet 



## Overview 
By default, all reads are proxied to your primary database. 

To see the full set of queries that have been proxied to your underlying database, use any MySQL or Postgres CLI to run the `SHOW PROXIED QUERIES;` command. 
This will return a list of select statements and query IDs. 

From there, you can cache specific queries via the `CREATE CACHED QUERY` command, remove existing caches using the `DROP CACHED QUERY` command, and see the full list 
of cached queries with the `SHOW CACHED QUERIES` command. 

See the SQL CLI Extensions docs below for more information about how to manage ReadySet's cache. 

## SQL CLI Extensions  

```CREATE CACHED QUERY [<name>] AS <select_statement>;```

The CREATE QUERY CACHE statement creates a new SQL query cache in a ReadySet cluster. Any parameters in the query should be specified using the usual positional (?) or numbered ($1) syntax, for example: 
`CREATE CACHED QUERY user_by_id AS SELECT * FROM users WHERE id = ?;`

The optional `<name>` field must either be a valid SQL identifier, or be quoted using the identifier quoting style for the dialect. If omitted, a name is 
generated by ReadySet based on the structure of the query. The name can be later used to refer to the query, for example in the `DROP CACHED QUERY` statement. 


If necessary, new query caches added to ReadySet will add new indexes to the tables referenced in the query. The time that it takes to do this scales linearly with the 
number of rows in the table. During the indexing operation, the client that is running the CREATE QUERY CACHE command and 
replication to that table in ReadySet will both block until the indexing operation is complete.

--- 

```DROP CACHED QUERY <name>;```

This statement removes a query cache from a ReadySet cluster, freeing up all memory used by that query cache (but not indexes created in tables for that query cache). 
The `<name>` field should be the name of the query cache, either explicitly provided to the `CREATE CACHED QUERY` command or automatically generated by ReadySet. 
In the case of automatically generated query cache names, the name can be obtained via the `SHOW CACHED QUERIES` command. 

---

```SHOW PROXIED QUERIES;```

The SHOW PROXIED QUERIES statement returns a virtual table containing all queries that are being forwarded to the upstream database instead of being 
run against ReadySet because the queries have not been created via the CREATE CACHED QUERY statement, or because the query is not supported by ReadySet. 

The resulting table will hahve one column: `proxied query`, which will contain the SQL source of the query. Note that this will contain the canonical 
structure of the SQL, not the original SQL passed to ReadySet. 


---

```SHOW CACHED QUERIES;```

statement returns a virtual table containing all query caches in the ReadySet cluster that have been manually created via the 
`CREATE CACHED QUERY` statement. The resulting table will have two columns: 
`name`, which will contain the name of the query, either explicitly passed to `CREATE CACHED QUERY` or automatically generated by ReadySet 
`query`, which will contain the SQL source of the query. Note that this will contain the canonical structure of the SQL, not the verbatim 
original SQL passed to ReadySet. 


## Write Handling
All writes sent to ReadySet will be proxied to your underlying database. To avoid the extra network hop, you can use separate read and write connection 
strings and set only your read connection string to point to your ReadySet cluster. 


## FAQs

#### How do I monitor cached query performance?

The ReadySet Dashboard shows how often a query is issued, the query latency at different percentiles, and whether the query is run on your upstream database or against the ReadySet cache.

#### Why is my cached query slow?

ReadySet, like most caches, requires some warm up period before query latencies become stable. Additionally, ReadySet requires some time to build an internal representation of a query after a `CREATE CACHES` statement has been issued. A more detailed explanation of the kind of workloads ReadySet is optimized for can be found [here](./guidelines). 

#### Is my query being sent to ReadySet or my upstream database?

The ReadySet dashboard updates with the number of times a query is run against the upstream database and the ReadySet cache. Additionally, ReadySet provides the `SHOW CACHES` and `SHOW PROXIED QUERIES` syntax to list the queries that are run against ReadySet and the upstream database respectively.

